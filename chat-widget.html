<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Widget</title>
  <style>
    .chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      font-family: "Helvetica Neue", Arial, sans-serif;
    }

    .chat-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border: none;
      border-radius: 999px;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .chat-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.4);
    }

    .chat-container {
      margin-top: 12px;
      width: 380px;
      height: 500px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.16);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chat-container.hidden {
      display: none;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #1d4ed8;
      color: #fff;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .chat-header button {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: #fff;
      border-radius: 8px;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .chat-header button:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.02);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px 14px 6px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #f8fafc;
    }

    .chat-message {
      max-width: 80%;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      word-break: break-word;
      white-space: pre-wrap;
    }

    .chat-message.user {
      align-self: flex-end;
      background: #2563eb;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant {
      align-self: flex-start;
      background: #e5e7eb;
      color: #111827;
      border-bottom-left-radius: 4px;
    }

    .chat-message.streaming {
      animation: pulse 1.4s ease-in-out infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .chat-form {
      display: flex;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid #e5e7eb;
      background: #fff;
    }

    .chat-form input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .chat-form input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .chat-form button[type="submit"] {
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      background: #2563eb;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      min-width: 70px;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .chat-form button[type="submit"]:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .chat-form button[type="submit"]:disabled,
    .chat-form input[type="text"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <div class="chat-widget" aria-live="polite">
    <button class="chat-toggle" type="button">ðŸ’¬ Ask Coach</button>

    <div class="chat-container hidden" role="dialog" aria-label="Coach chat">
      <div class="chat-header">
        <span>Coach Chat</span>
        <button class="chat-close" type="button" aria-label="Close chat">Ã—</button>
      </div>
      <div class="chat-messages" aria-live="polite"></div>
      <form class="chat-form" autocomplete="off">
        <input type="text" name="message" placeholder="Ask a question..." required />
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <script>
    (() => {
      const widget = document.querySelector(".chat-widget");
      if (!widget) return;

      const toggleButton = widget.querySelector(".chat-toggle");
      const container = widget.querySelector(".chat-container");
      const closeButton = widget.querySelector(".chat-close");
      const messagesEl = widget.querySelector(".chat-messages");
      const form = widget.querySelector(".chat-form");
      const input = form.querySelector('input[name="message"]');
      const submitButton = form.querySelector('button[type="submit"]');

      const messageHistory = [];
      const decoder = new TextDecoder();

      const disclaimer =
        "Hi! Iâ€™m your coaching assistant. I can help with motivation, habits, and training ideas, but I am not a medical professional and this is not medical advice. Always consult a healthcare provider before making health decisions.";

      addMessage("assistant", disclaimer);
      messageHistory.push({ role: "assistant", content: disclaimer });

      toggleButton.addEventListener("click", () => {
        container.classList.toggle("hidden");
        if (!container.classList.contains("hidden")) {
          input.focus();
        }
      });

      closeButton.addEventListener("click", () => {
        container.classList.add("hidden");
        toggleButton.focus();
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const content = input.value.trim();
        if (!content) return;

        const userMessage = { role: "user", content };
        addMessage("user", content);
        messageHistory.push(userMessage);
        input.value = "";

        const assistantEl = addMessage("assistant", "", { streaming: true });
        setInputDisabled(true);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "text/event-stream",
            },
            body: JSON.stringify({
              messages: messageHistory,
              context: getCoachingContext(),
            }),
            signal: controller.signal,
          });

          if (!response.ok || !response.body) {
            throw new Error("Chat request failed.");
          }

          const reader = response.body.getReader();
          let buffer = "";
          let assistantText = "";
          let doneStreaming = false;

          while (!doneStreaming) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const chunks = buffer.split("\n\n");
            buffer = chunks.pop() || "";

            for (const chunk of chunks) {
              const trimmed = chunk.trim();
              if (!trimmed.startsWith("data:")) continue;
              const dataStr = trimmed.replace(/^data:\s*/, "");

              if (dataStr === "[DONE]") {
                doneStreaming = true;
                break;
              }

              try {
                const payload = JSON.parse(dataStr);
                const delta = payload?.text || payload?.content || "";
                assistantText += delta;
                updateMessage(assistantEl, assistantText);
              } catch (err) {
                // Not JSON - treat as plain text
                assistantText += dataStr;
                updateMessage(assistantEl, assistantText);
              }
            }
          }

          assistantEl.classList.remove("streaming");
          assistantText = assistantText.trim();
          updateMessage(assistantEl, assistantText || "...");

          if (assistantText) {
            messageHistory.push({ role: "assistant", content: assistantText });
          }
        } catch (error) {
          assistantEl.classList.remove("streaming");
          updateMessage(
            assistantEl,
            "Sorry, something went wrong. Please try again."
          );
          console.error(error);
        } finally {
          clearTimeout(timeoutId);
          setInputDisabled(false);
          scrollMessagesToBottom();
        }
      });

      function setInputDisabled(disabled) {
        input.disabled = disabled;
        submitButton.disabled = disabled;
      }

      function scrollMessagesToBottom() {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function addMessage(role, content, options = {}) {
        const el = document.createElement("div");
        el.className = `chat-message ${role}`;
        if (options.streaming) el.classList.add("streaming");
        el.textContent = content;
        messagesEl.appendChild(el);
        scrollMessagesToBottom();
        return el;
      }

      function updateMessage(el, content) {
        el.textContent = content;
        scrollMessagesToBottom();
      }

      function getCoachingContext() {
        const data = window.currentWeekData;
        if (!data) {
          return "No currentWeekData provided.";
        }

        if (typeof data === "string") return data;

        if (typeof data === "object") {
          try {
            return JSON.stringify(data, null, 2);
          } catch (err) {
            console.error("Failed to serialize context", err);
          }
        }

        return String(data);
      }
    })();
  </script>
</body>
</html>
